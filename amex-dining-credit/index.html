<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>AMEX Dining credit locations</title>
    <style>
        body { font-family: "SF Pro", sans-serif; }
        a { text-decoration: none }
    </style>
</head>

<body>
<header style="display: flex; gap: 2rem; align-items: baseline">
    <h1>AMEX Dining Credit restaurants</h1>

    <nav>
        <select id="country-chooser">
            <option>â€” Choose country â€”</option>
            <optgroup label="Asia &amp; Oceanic">
                <option value="AU" data-lat="-23.033333" data-lng="132.166667">Australia</option>
                <option value="HK" data-lat="22.281944" data-lng="114.158056">Hong Kong</option>
                <option value="JP" data-lat="34.64314" data-lng="134.99722">Japan</option>
                <option value="NZ" data-lat="-41.272833" data-lng="173.299361">New Zealand</option>
                <option value="SG" data-lat="1.291667" data-lng="103.85">Singapore</option>
                <option value="TW" data-lat="23.973861" data-lng="120.982">Taiwan</option>
                <option value="TH" data-lat="15" data-lng="100">Thailand</option>
            </optgroup>
            <optgroup label="Europe">
                <option value="AT" data-lat="47.6966322" data-lng="13.3457076">Austria</option>
                <option value="BE" data-lat="50.846667" data-lng="4.3525">Belgium &amp; Luxembourg</option>
                <option value="FI" data-lat="62.5" data-lng="25.5">Finland</option>
                <option value="FR" data-lat="46.316667" data-lng="2.533333">France</option>
                <option value="DE" data-lat="51.163375" data-lng="10.447683">Germany</option>
                <option value="IT" data-lat="43" data-lng="12">Italy</option>
                <option value="NL" data-lat="51.916667" data-lng="5.566667">Netherlands</option>
                <option value="ES" data-lat="39.926667" data-lng="-1.801667">Spain</option>
                <option value="SE" data-lat="61.316667" data-lng="14.833333">Sweden</option>
                <option value="GB" data-lat="54.00366" data-lng="-2.547855">United Kingdom</option>
            </optgroup>
            <optgroup label="North &amp; South America">
                <option value="CA" data-lat="56" data-lng="-109">Canada</option>
                <option value="MX" data-lat="23.316667" data-lng="-102.366667">Mexico</option>
                <option value="US" data-lat="40" data-lng="-100">United States</option>
            </optgroup>
        </select>
    </nav>
</header>

<div id="map" style="width: 80%;height: 80vh; margin: 0 auto"></div>

<script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyCsQbB1qCK4L0OkFjsSu2gsySgP9hm6sIM",
        v: "weekly",
        // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
        // Add other bootstrap parameters as needed, using camel case.
    });
</script>
<script>
!function() {

    function amexMerchantsToPlaces(amexApiMerchants) {
        return amexApiMerchants.flatMap(amexMerchant => {
            if (amexMerchant.isMerchantGroup) {
                // this happens when there is a "merchantGroup";
                // like Gordon Ramsey etc. Those have a sub node in ".merchants"
                // that again look like the merchants on the first level.
                // We have to make a recursion here (yay), like:
                console.log("Merchant group!", amexMerchant.name);
                return amexMerchantsToPlaces(amexMerchant.merchants);
            }
            let assumedLocation =
                amexMerchant.googleMapsUrl.match(/@(?<lat>-?\d+(?:\.\d+)?),(?<lon>-?\d+(?:\.\d+)?)/)?.groups ?? null;
            if (assumedLocation?.lat) assumedLocation.lat = parseFloat(assumedLocation.lat);
            if (assumedLocation?.lon) assumedLocation.lon = parseFloat(assumedLocation.lon);
            return {
                "name": amexMerchant.name,
                "address": amexMerchant.address,
                "zip": amexMerchant.postcode,
                "city": amexMerchant.city.title,
                //"googlePlaceTextQuery": `${amexMerchant.name}, ${amexMerchant.address}, ${amexMerchant.postcode} ${amexMerchant.city.title}`,
                "assumedLocation": assumedLocation,
                //"amexRaw": amexMerchant,
            }
        });
    }

    let map;

    async function initMap() {
        const { Map } = await google.maps.importLibrary("maps");

        map = new Map(document.getElementById("map"), {
            center: { lat: 51.163375, lng: 10.447683 },
            zoom: 6,
            mapId: "DEMO_MAP_ID"
        });
    }

    initMap();

    async function fillMarkers(country = "DE") {
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

        let merchantsJson;
        let cachedMerchantsData = localStorage.getItem("amex-dining-merchants-"+country);
        if (!cachedMerchantsData) {
            console.debug("No merchants info found in LocalStorage for "+country+", fetching from remote");
            const amexApiMerchants = await (
                await fetch(
                    `https://dining-offers-prod.amex.r53.tuimedia.com/api/country/${country}/merchants`))
                .json();
            merchantsJson = amexMerchantsToPlaces(amexApiMerchants);
            localStorage.setItem("amex-dining-merchants-"+country, JSON.stringify(merchantsJson));
        } else {
            merchantsJson = JSON.parse(cachedMerchantsData);
        }
        console.info("merchants for "+country+":", merchantsJson);

        merchantsJson.forEach(item => {
            if (!item.assumedLocation) {
                console.warn("Could not find a location for", item);
                return;
            }
            new AdvancedMarkerElement({
                map,
                position: { lat: item.assumedLocation.lat, lng: item.assumedLocation.lon },
                title: item.name,
            });
        });
    }

document.getElementById("country-chooser").addEventListener("change", (event) => {
    const select = event.target;
    if (!select.matches("select")) return;

    fillMarkers(select.value);

    const selectedOption = select.options[select.selectedIndex];
    map.panTo({lat: parseFloat(selectedOption.dataset.lat), lng: parseFloat(selectedOption.dataset.lng)});
});

}();
</script>

<footer style="margin-top: 1rem">
    Source:
        <a href="https://www.americanexpress.com/en-gb/benefits/diningbenefit/">ðŸ‡¬ðŸ‡§</a>
        <a href="https://www.americanexpress.com/de-de/benefits/diningbenefit/">ðŸ‡©ðŸ‡ª</a>
</footer>

</body>
</html>
