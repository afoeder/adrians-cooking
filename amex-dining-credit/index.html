<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>AMEX Dining credit locations</title>
    <style>
        body { font-family: "SF Pro", sans-serif; }
    </style>
</head>

<body>
<header style="display: flex; gap: 2rem; align-items: baseline">
    <h1>AMEX Dining Credit restaurants</h1>

    <nav>
        <ul id="country-chooser" style="display: flex; gap: .5rem; list-style-type: none; padding: 0;">
            <li><a href="#DE" data-lat="51.163375" data-lng="10.447683">DE</a></li>
            <li><a href="#GB" data-lat="54.00366" data-lng="-2.547855">GB</a></li>
        </ul>
    </nav>
</header>

<div id="map" style="width: 80%;height: 80vh; margin: 0 auto"></div>

<script>
    (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
        key: "AIzaSyCsQbB1qCK4L0OkFjsSu2gsySgP9hm6sIM",
        v: "weekly",
        // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
        // Add other bootstrap parameters as needed, using camel case.
    });
</script>
<script>
!function() {

    function amexMerchantsToPlaces(amexApiMerchants) {
        return amexApiMerchants.flatMap(amexMerchant => {
            if (amexMerchant.isMerchantGroup) {
                // this happens when there is a "merchantGroup";
                // like Gordon Ramsey etc. Those have a sub node in ".merchants"
                // that again look like the merchants on the first level.
                // We have to make a recursion here (yay), like:
                console.log("Merchant group!", amexMerchant.name);
                return amexMerchantsToPlaces(amexMerchant.merchants);
            }
            let assumedLocation =
                amexMerchant.googleMapsUrl.match(/@(?<lat>-?\d+(?:\.\d+)?),(?<lon>-?\d+(?:\.\d+)?)/)?.groups ?? null;
            if (assumedLocation?.lat) assumedLocation.lat = parseFloat(assumedLocation.lat);
            if (assumedLocation?.lon) assumedLocation.lon = parseFloat(assumedLocation.lon);
            return {
                "name": amexMerchant.name,
                "address": amexMerchant.address,
                "zip": amexMerchant.postcode,
                "city": amexMerchant.city.title,
                //"googlePlaceTextQuery": `${amexMerchant.name}, ${amexMerchant.address}, ${amexMerchant.postcode} ${amexMerchant.city.title}`,
                "assumedLocation": assumedLocation,
                //"amexRaw": amexMerchant,
            }
        });
    }

    let map;

    async function initMap() {
        const { Map } = await google.maps.importLibrary("maps");

        map = new Map(document.getElementById("map"), {
            center: { lat: 51.163375, lng: 10.447683 },
            zoom: 6,
            mapId: "DEMO_MAP_ID"
        });
    }

    initMap();

    async function fillMarkers(country = "DE") {
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

        let merchantsJson;
        let cachedMerchantsData = localStorage.getItem("amex-dining-merchants-"+country);
        if (!cachedMerchantsData) {
            console.debug("No merchants info found in LocalStorage for "+country+", fetching from remote");
            const amexApiMerchants = await (
                await fetch(
                    `https://dining-offers-prod.amex.r53.tuimedia.com/api/country/${country}/merchants`))
                .json();
            merchantsJson = amexMerchantsToPlaces(amexApiMerchants);
            localStorage.setItem("amex-dining-merchants-"+country, JSON.stringify(merchantsJson));
        } else {
            merchantsJson = JSON.parse(cachedMerchantsData);
        }
        console.info("merchants for "+country+":", merchantsJson);

        merchantsJson.forEach(item => {
            if (!item.assumedLocation) {
                return;
            }
            new AdvancedMarkerElement({
                map,
                position: { lat: item.assumedLocation.lat, lng: item.assumedLocation.lon },
                title: item.name,
            });
        });
    }

document.getElementById("country-chooser").addEventListener("click", (event) => {
    const link = event.target;
    if (!link.matches("a")) return;

    const language = link.getAttribute("href").match(/(?<=#)[A-Z]{2}/).at(0);
    fillMarkers(language);
    map.panTo({lat: parseFloat(link.dataset.lat), lng: parseFloat(link.dataset.lng)});
});

}();
</script>

</body>
</html>
